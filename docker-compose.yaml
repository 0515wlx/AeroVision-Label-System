# AeroVision Label System - Docker Compose (GPU 版本)
# 使用方法: docker-compose up -d

version: '3.8'

services:
  aerovision:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DEVICE: gpu
        CUDA_VERSION: "12.6"
    image: aerovision-label:gpu
    container_name: aerovision-label

    ports:
      - "${FLASK_PORT:-5000}:5000"

    volumes:
      - ${IMAGES_DIR:-./images}:/app/images
      - ${LABELED_DIR:-./labeled}:/app/labeled
      - ./data:/app/data
      - ./config.yaml:/app/config.yaml:ro
      - ${MODELS_DIR:-./models}:/app/models:ro

    environment:
      # Flask 配置
      - FLASK_ENV=production
      - FLASK_PORT=5000
      # 目录配置
      - IMAGES_DIR=/app/images
      - LABELED_DIR=/app/labeled
      - DATABASE_PATH=/app/data/labels.db
      - AI_CONFIG_PATH=/app/config.yaml
      # OCR API 地址（必须配置，优先使用 .env 文件）
      - OCR_API_URL=${OCR_API_URL:-http://host.docker.internal:8000/v2/models/ocr/infer}
      # CPU 线程配置
      - OMP_NUM_THREADS=${CPU_THREADS:-4}
      - MKL_NUM_THREADS=${CPU_THREADS:-4}
      - OPENBLAS_NUM_THREADS=${CPU_THREADS:-4}
      - TORCH_NUM_THREADS=${CPU_THREADS:-4}

    # GPU 支持
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          cpus: '${CPU_LIMIT:-4.0}'
          memory: ${MEMORY_LIMIT:-8G}

    shm_size: '2gb'
    restart: unless-stopped

    # 添加宿主机地址映射（支持访问宿主机服务）
    extra_hosts:
      - "host.docker.internal:host-gateway"

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/stats"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    networks:
      - aerovision-network

networks:
  aerovision-network:
    driver: bridge
